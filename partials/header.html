<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LernApp</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <link rel="stylesheet" href="css/fixed-layout.css">
    <style>
        .app-logo-button {
            cursor: pointer; /* Change cursor to pointer to indicate clickability */
            text-decoration: none; /* Ensure no underline is shown */
        }
        .btn {
            padding: 10px 20px;
            margin: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .app-logo-button i {
            color: blue; /* Icon immer blau */
        }
        .app-logo-button span {
            color: black; /* Text immer schwarz */
        }
        /* Gemeinsame Stile für alle Menübuttons */
        #user-buttons a, .admin-button {
            margin-right: 15px; /* Abstand zwischen den Buttons */
            color: black; /* Textfarbe immer schwarz */
            text-decoration: none; /* Keine Unterstreichung */
            transition: color 0.3s ease; /* Weicher Übergang für Hover-Effekt */
        }
        #user-buttons a:hover, .admin-button:hover {
            color: #007bff; /* Dezente Farbänderung beim Hover */
        }

        /* Breadcrumb Navigation Stile */
        .breadcrumb-container {
            padding: 10px 20px;
            background-color: #f8f9fa;
            border-radius: 4px;
            margin: 10px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }

        .breadcrumb-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }

        .breadcrumb-item {
            display: inline-flex;
            align-items: center;
        }

        .breadcrumb-item:not(:last-child)::after {
            content: "›";
            margin: 0 8px;
            color: #6c757d;
            font-weight: bold;
        }

        .breadcrumb-link {
            color: #007bff;
            text-decoration: none;
            transition: color 0.2s;
            font-size: 0.95rem;
        }

        .breadcrumb-link:hover {
            color: #0056b3;
            text-decoration: underline;
        }

        .breadcrumb-current {
            color: #6c757d;
            font-weight: 600;
            font-size: 0.95rem;
        }

        /* Für mobile Ansicht */
        @media (max-width: 576px) {
            .breadcrumb-container {
                padding: 8px 12px;
                margin: 5px 0;
            }
            
            .breadcrumb-item:not(:last-child)::after {
                margin: 0 5px;
            }
            
            .breadcrumb-link, .breadcrumb-current {
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <nav>
        <a href="index.html" class="app-logo-button" id="app-logo-button">
            <i class="fas fa-graduation-cap"></i>
            <span>LernApp</span>
        </a>
        <ul>
            <li><a href="admin.html" class="admin-button" id="admin-button">Admin</a></li>
            <li id="user-buttons" style="display: none;">
                <a href="profile.html" class="profile-button" id="profile-button">Profil</a>
                <a href="#" class="logout-button" id="logout-button" onclick="handleLogout()">Ausloggen</a>
            </li>
        </ul>
        <div class="header-right"></div>
    </nav>

    <!-- Breadcrumb Navigation -->
    <div class="breadcrumb-container" id="breadcrumb-container" style="display: none;">
        <nav aria-label="Breadcrumb Navigation">
            <ol class="breadcrumb-list" id="breadcrumb-list">
                <!-- Breadcrumbs werden dynamisch eingefügt -->
            </ol>
        </nav>
    </div>    
    <script src="js/notification.js"></script>
    <!-- Zentrale Einbindung der Auth-Funktionen -->
    <script src="js/auth.js"></script>
    <script>
        // Logs persistent machen, auch nach Logout
        window.handleLogout = function() {
            try {
                // Wir stellen eine globale log-Funktion für Legacy-Code bereit (falls noch nicht definiert)
                if (!window.log) {
                    window.log = function(message, type) {
                        if (window.logger) {
                            window.logger.log(message, type || 'info');
                        } else if (window.logMessage) {
                            window.logMessage(message, type || 'info');
                        } else {
                            console.log(message);
                        }
                    };
                }
                
                // Nur relevante Daten aus localStorage entfernen, Logs bleiben erhalten
                const logs = localStorage.getItem('persistentLogs');
                localStorage.clear();
                if (logs) {
                    localStorage.setItem('persistentLogs', logs);
                }
                log('localStorage nach Logout: ' + JSON.stringify(localStorage));
                window.location.href = 'index.html'; // Weiterleitung zur Startseite wieder aktiviert
            } catch (error) {
                console.error('Fehler beim Logout:', error);
            }
        };

        // Variable zum Tracken des letzten Aufrufs
        let lastNavigationUpdateTime = 0;
        
        // Funktion zur Aktualisierung der Navigation basierend auf Login-Status
        window.updateNavigation = function() {
            // Throttling: Verhindere zu häufige Aufrufe (max. einmal alle 500ms)
            const now = Date.now();
            if (now - lastNavigationUpdateTime < 500) {
                // Zu schneller wiederholter Aufruf - abbrechen
                return;
            }
            lastNavigationUpdateTime = now;
            
            // Zentrale Logging-Funktion verwenden - mit Fallbacks für alle Varianten
            const logger = window.logger || { log: console.log, error: console.error };
            
            // Wir stellen auch eine globale log-Funktion für Legacy-Code bereit
            window.log = function(message, type) {
                if (window.logger) {
                    window.logger.log(message, type || 'info');
                } else if (window.logMessage) {
                    window.logMessage(message, type || 'info');
                } else {
                    console.log(message);
                }
            };
            
            log('Navigation wird aktualisiert.');

            const adminButton = document.getElementById('admin-button');
            const userButtons = document.getElementById('user-buttons');
            const appLogoButton = document.getElementById('app-logo-button');
            const isLoggedIn = localStorage.getItem('loggedIn') === 'true';

            log('Überprüfe, ob adminButton existiert: ' + !!adminButton);
            log('Überprüfe, ob userButtons existiert: ' + !!userButtons);
            log('Login-Status: ' + isLoggedIn);

            if (adminButton) {
                // Log deaktiviert: Admin-Button gefunden. Setze Sichtbarkeit.
                adminButton.style.display = isLoggedIn ? 'none' : 'block';
                // Log deaktiviert: Admin-Button Sichtbarkeit nach Änderung
            } else {
                log('Admin-Button nicht gefunden.', 'error');
            }

            if (userButtons) {
                // Log deaktiviert: User-Buttons gefunden. Setze Sichtbarkeit.
                userButtons.style.display = isLoggedIn ? 'block' : 'none';
                // Log deaktiviert: User-Buttons Sichtbarkeit nach Änderung
            } else {
                log('User-Buttons Gruppe nicht gefunden.', 'error');
            }

            if (appLogoButton) {
                log('App-Logo-Button gefunden. Setze Link.');

                // Setze den Link basierend auf dem Login-Status
                if (isLoggedIn) {
                    appLogoButton.href = 'dashboard.html';
                    log('Benutzer ist eingeloggt. Link auf Dashboard gesetzt.');
                } else {
                    appLogoButton.href = 'index.html';
                    log('Benutzer ist nicht eingeloggt. Link auf Index gesetzt.');
                }

                log('App-Logo-Button Link nach Änderung: ' + appLogoButton.href);
            } else {
                log('App-Logo-Button nicht gefunden.', 'error');
            }

            log('Navigation aktualisiert.');
        }

        // Wir führen updateNavigation nicht sofort aus und auch nicht bei DOMContentLoaded
        // Es wird später explizit aufgerufen, wenn der Header in die Seite geladen wurde
        // Dies vermeidet doppelte Aufrufe und damit doppelte Log-Einträge

        // Breadcrumb-Funktionen
        window.breadcrumbs = {
            // Aktuelle Breadcrumb-Pfad (wird von Seiten gespeichert)
            path: [],
            
            // Container- und Listen-Referenzen
            container: null,
            list: null,
            
            // Initialisiert die Breadcrumb-Navigation
            init: function() {
                this.container = document.getElementById('breadcrumb-container');
                this.list = document.getElementById('breadcrumb-list');
                
                // Versuche gespeicherten Pfad zu laden
                this.loadState();
                
                // Prüfe, ob wir auf einer Seite sind, die Breadcrumbs anzeigen sollte
                this.updateVisibility();
            },
            
            // Setzt einen neuen Breadcrumb-Pfad
            set: function(newPath) {
                if (!Array.isArray(newPath)) {
                    console.error('Breadcrumb-Pfad muss ein Array sein');
                    return;
                }
                
                this.path = newPath;
                this.saveState();
                this.render();
                this.updateVisibility();
            },
            
            // Fügt einen Breadcrumb zum Pfad hinzu
            add: function(label, url = null) {
                // Prüfen, ob dieser Breadcrumb bereits existiert
                const existingIndex = this.path.findIndex(item => item.label === label);
                
                if (existingIndex >= 0) {
                    // Wenn gefunden, schneide den Pfad ab diesem Punkt ab
                    this.path = this.path.slice(0, existingIndex + 1);
                } else {
                    // Sonst füge neuen Breadcrumb hinzu
                    this.path.push({ label, url });
                }
                
                this.saveState();
                this.render();
                this.updateVisibility();
            },
            
            // Entfernt alle Breadcrumbs bis zu einem bestimmten Index
            navigateTo: function(index) {
                if (index >= 0 && index < this.path.length) {
                    this.path = this.path.slice(0, index + 1);
                    this.saveState();
                    this.render();
                    
                    // Wenn eine URL vorhanden ist, navigiere dorthin
                    const item = this.path[index];
                    if (item && item.url) {
                        window.location.href = item.url;
                    }
                }
            },
            
            // Löscht alle Breadcrumbs
            clear: function() {
                this.path = [];
                this.saveState();
                this.render();
                this.updateVisibility();
            },
            
            // Aktualisiert die Sichtbarkeit des Breadcrumb-Containers
            updateVisibility: function() {
                if (!this.container) return;
                
                // Zeige Breadcrumbs nur an, wenn Pfad vorhanden ist und wir nicht auf der Startseite sind
                const isHomePage = window.location.pathname.endsWith('index.html') || 
                                   window.location.pathname.endsWith('/');
                const shouldShow = this.path.length > 0 && !isHomePage;
                
                this.container.style.display = shouldShow ? 'block' : 'none';
            },
            
            // Rendert die aktuellen Breadcrumbs
            render: function() {
                if (!this.list) return;
                
                // Liste leeren
                this.list.innerHTML = '';
                
                // Startpunkt immer hinzufügen
                const homeLi = document.createElement('li');
                homeLi.className = 'breadcrumb-item';
                
                const homeLink = document.createElement('a');
                homeLink.className = 'breadcrumb-link';
                homeLink.href = localStorage.getItem('loggedIn') === 'true' ? 'dashboard.html' : 'index.html';
                homeLink.textContent = 'Start';
                homeLink.onclick = (e) => {
                    e.preventDefault();
                    this.clear();
                    window.location.href = homeLink.href;
                };
                
                homeLi.appendChild(homeLink);
                this.list.appendChild(homeLi);
                
                // Restlichen Pfad rendern
                this.path.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = 'breadcrumb-item';
                    
                    if (index === this.path.length - 1) {
                        // Letzter Eintrag (aktuell)
                        const span = document.createElement('span');
                        span.className = 'breadcrumb-current';
                        span.textContent = item.label;
                        li.appendChild(span);
                    } else {
                        // Navigierbarer Eintrag
                        const a = document.createElement('a');
                        a.className = 'breadcrumb-link';
                        a.href = item.url || '#';
                        a.textContent = item.label;
                        
                        // Event-Handler für Navigation
                        a.onclick = (e) => {
                            e.preventDefault();
                            this.navigateTo(index);
                        };
                        
                        li.appendChild(a);
                    }
                    
                    this.list.appendChild(li);
                });
            },
            
            // Speichert den aktuellen Pfad im localStorage
            saveState: function() {
                try {
                    localStorage.setItem('breadcrumbPath', JSON.stringify(this.path));
                } catch (error) {
                    console.error('Fehler beim Speichern des Breadcrumb-Pfads:', error);
                }
            },
            
            // Lädt den gespeicherten Pfad aus dem localStorage
            loadState: function() {
                try {
                    const savedPath = localStorage.getItem('breadcrumbPath');
                    if (savedPath) {
                        this.path = JSON.parse(savedPath);
                    }
                } catch (error) {
                    console.error('Fehler beim Laden des Breadcrumb-Pfads:', error);
                    this.path = [];
                }
            }
        };
        
        // Breadcrumb-Navigation initialisieren
        document.addEventListener('DOMContentLoaded', function() {
            window.breadcrumbs.init();
        });

        // Stellt sicher, dass showLogs global verfügbar ist
        window.showLogs = function() {
            const logs = JSON.parse(localStorage.getItem('persistentLogs')) || [];
            const logContainer = document.createElement('div');
            logContainer.style.padding = '10px';
            logContainer.style.margin = '10px';
            logContainer.style.border = '1px solid #ccc';
            logContainer.style.backgroundColor = '#f9f9f9';
            logContainer.style.maxHeight = '300px';
            logContainer.style.overflowY = 'scroll';

            logs.forEach(log => {
                const logEntry = document.createElement('p');
                logEntry.textContent = `${log.timestamp}: ${log.message}`;
                logContainer.appendChild(logEntry);
            });

            const headerRight = document.querySelector('.header-right');
            headerRight.appendChild(logContainer);
        };
    </script>
</body>
</html>
