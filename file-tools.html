<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LernApp Datei-Tools</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .tool-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: #f5f5f5;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .action-button {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        .action-button:hover {
            background-color: #45a049;
        }
        
        .action-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .status-area {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            background-color: #f9f9f9;
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .status-item {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 4px;
        }
        
        .status-info {
            background-color: #e3f2fd;
            border-left: 4px solid #2196F3;
        }
        
        .status-success {
            background-color: #e8f5e9;
            border-left: 4px solid #4CAF50;
        }
        
        .status-warning {
            background-color: #fff8e1;
            border-left: 4px solid #FFC107;
        }
        
        .status-error {
            background-color: #ffebee;
            border-left: 4px solid #F44336;
        }
    </style>
    <!-- Zentrales Logging-System laden -->
    <script src="js/logger.js"></script>
    <script src="js/notification.js"></script>
</head>
<body>
    <div id="header-container"></div>

    <main>
        <div class="tool-container">
            <h1>LernApp Datei-Tools</h1>
            <p>Mit diesen Tools kannst du Probleme mit deinen LernApp-Dateien beheben.</p>
            
            <div>
                <h2>Aktionen</h2>
                <button id="diagnoseBtn" class="action-button">Dateisystem analysieren</button>
                <button id="moveFilesBtn" class="action-button">Dateien aus 'muskeln' Ordner verschieben</button>
                <button id="reloadBtn" class="action-button">Seite neu laden</button>
            </div>
            
            <div class="status-area" id="statusArea">
                <div class="status-item status-info">
                    Wähle eine Aktion aus...
                </div>
            </div>
        </div>
    </main>

    <div id="footer-container"></div>

    <script src="js/auth.js"></script>
    <script src="js/storage-loader.js"></script>
    <script src="js/file-tools.js"></script>
    <script>
        // Header und Footer dynamisch laden
        async function loadHeaderAndFooter() {
            try {
                document.getElementById('header-container').innerHTML = await (await fetch('partials/header.html')).text();
                document.getElementById('footer-container').innerHTML = await (await fetch('partials/footer.html')).text();
                
                const headerScripts = document.getElementById('header-container').querySelectorAll('script');
                for (const script of headerScripts) {
                    if (script.innerText) {
                        eval(script.innerText);
                    }
                }
                
                if (window.updateNavigation) {
                    window.updateNavigation();
                }
            } catch (error) {
                console.error('Fehler beim Laden des Headers oder Footers:', error);
            }
        }
        
        loadHeaderAndFooter();
        
        // Status-Bereich aktualisieren
        function addStatus(message, type = 'info') {
            const statusArea = document.getElementById('statusArea');
            const statusItem = document.createElement('div');
            statusItem.className = `status-item status-${type}`;
            statusItem.textContent = message;
            statusArea.appendChild(statusItem);
            statusArea.scrollTop = statusArea.scrollHeight;
        }
        
        // Event-Listener für Buttons
        document.getElementById('diagnoseBtn').addEventListener('click', async function() {
            if (!window.directoryHandle) {
                addStatus('Kein DirectoryHandle verfügbar. Bitte wähle zuerst einen Speicherort im Profil aus.', 'error');
                return;
            }
            
            addStatus('Starte Dateisystem-Analyse...');
            
            try {
                // Dateien im Hauptverzeichnis auflisten
                const files = [];
                for await (const [name, entry] of window.directoryHandle.entries()) {
                    files.push({ name, kind: entry.kind });
                }
                
                addStatus(`${files.length} Dateien/Ordner im Hauptverzeichnis gefunden.`);
                
                // Prüfen, ob die benötigten Dateien vorhanden sind
                const hasCategories = files.some(f => f.name === 'categories.json');
                const hasGroups = files.some(f => f.name === 'groups.json');
                const hasQuestions = files.some(f => f.name === 'questions.json');
                
                if (hasCategories && hasGroups && hasQuestions) {
                    addStatus('Alle benötigten JSON-Dateien wurden im Hauptverzeichnis gefunden!', 'success');
                } else {
                    addStatus('Nicht alle benötigten Dateien wurden im Hauptverzeichnis gefunden:', 'warning');
                    addStatus(`- categories.json: ${hasCategories ? 'Vorhanden' : 'Fehlt'}`);
                    addStatus(`- groups.json: ${hasGroups ? 'Vorhanden' : 'Fehlt'}`);
                    addStatus(`- questions.json: ${hasQuestions ? 'Vorhanden' : 'Fehlt'}`);
                }
                
                // Nach dem muskeln-Ordner suchen
                const muskelnDir = files.find(f => f.kind === 'directory' && f.name === 'muskeln');
                if (muskelnDir) {
                    addStatus("'muskeln' Ordner gefunden, prüfe Inhalt...");
                    
                    try {
                        const muskelnHandle = await window.directoryHandle.getDirectoryHandle('muskeln');
                        const muskelnFiles = [];
                        
                        for await (const [name, entry] of muskelnHandle.entries()) {
                            muskelnFiles.push({ name, kind: entry.kind });
                        }
                        
                        addStatus(`${muskelnFiles.length} Dateien im 'muskeln' Ordner gefunden.`);
                        
                        // Prüfen, ob die JSON-Dateien im muskeln-Ordner sind
                        const hasMuskelnCategories = muskelnFiles.some(f => f.name === 'categories.json');
                        const hasMuskelnGroups = muskelnFiles.some(f => f.name === 'groups.json');
                        const hasMuskelnQuestions = muskelnFiles.some(f => f.name === 'questions.json');
                        
                        if (hasMuskelnCategories || hasMuskelnGroups || hasMuskelnQuestions) {
                            addStatus("JSON-Dateien im 'muskeln' Ordner gefunden!", 'warning');
                            addStatus("Diese Dateien müssen ins Hauptverzeichnis verschoben werden, damit die App sie finden kann.");
                            addStatus("Klicke auf 'Dateien aus 'muskeln' Ordner verschieben', um dieses Problem zu beheben.");
                        } else {
                            addStatus("Keine JSON-Dateien im 'muskeln' Ordner gefunden.");
                        }
                    } catch (error) {
                        addStatus(`Fehler beim Zugriff auf 'muskeln' Ordner: ${error.message}`, 'error');
                    }
                } else {
                    addStatus("Kein 'muskeln' Ordner gefunden");
                }
                
                addStatus('Dateisystem-Analyse abgeschlossen.', 'success');
            } catch (error) {
                addStatus(`Fehler bei der Dateisystem-Analyse: ${error.message}`, 'error');
            }
        });
        
        document.getElementById('moveFilesBtn').addEventListener('click', async function() {
            if (!window.directoryHandle) {
                addStatus('Kein DirectoryHandle verfügbar. Bitte wähle zuerst einen Speicherort im Profil aus.', 'error');
                return;
            }
            
            addStatus('Starte Verschieben der Dateien aus dem muskeln-Ordner...');
            
            try {
                // Unterordner öffnen
                let muskelnHandle;
                try {
                    muskelnHandle = await window.directoryHandle.getDirectoryHandle('muskeln');
                } catch (error) {
                    addStatus(`Ordner 'muskeln' nicht gefunden: ${error.message}`, 'error');
                    return;
                }
                
                // Dateien im Unterordner auflisten
                const files = [];
                for await (const [name, entry] of muskelnHandle.entries()) {
                    if (entry.kind === 'file') {
                        files.push({ name, entry });
                    }
                }
                
                addStatus(`${files.length} Dateien zum Verschieben gefunden`);
                
                if (files.length === 0) {
                    addStatus('Keine Dateien im Ordner gefunden.', 'warning');
                    return;
                }
                
                // Dateien verschieben
                let successCount = 0;
                for (const { name, entry } of files) {
                    try {
                        const file = await entry.getFile();
                        const content = await file.text();
                        
                        // Neue Datei im Hauptverzeichnis erstellen
                        const newFileHandle = await window.directoryHandle.getFileHandle(name, { create: true });
                        const writable = await newFileHandle.createWritable();
                        await writable.write(content);
                        await writable.close();
                        
                        addStatus(`Datei '${name}' erfolgreich ins Hauptverzeichnis kopiert`, 'success');
                        successCount++;
                    } catch (error) {
                        addStatus(`Fehler beim Verschieben von '${name}': ${error.message}`, 'error');
                    }
                }
                
                if (successCount > 0) {
                    addStatus(`${successCount} von ${files.length} Dateien erfolgreich verschoben.`, 'success');
                    addStatus('Bitte lade die Seite neu, um die Änderungen zu sehen.', 'info');
                } else {
                    addStatus('Keine Dateien konnten verschoben werden.', 'error');
                }
            } catch (error) {
                addStatus(`Fehler beim Verschieben der Dateien: ${error.message}`, 'error');
            }
        });
        
        document.getElementById('reloadBtn').addEventListener('click', function() {
            addStatus('Lade Seite neu...');
            setTimeout(() => {
                window.location.reload();
            }, 500);
        });
        
        // Initial Status
        setTimeout(() => {
            if (!window.directoryHandle) {
                addStatus('Kein DirectoryHandle gefunden. Bitte gehe zum Profil und wähle einen Speicherort aus.', 'warning');
            } else {
                addStatus(`DirectoryHandle gefunden: ${window.directoryHandle.name}`, 'success');
                addStatus('Klicke auf "Dateisystem analysieren", um zu prüfen, ob die JSON-Dateien korrekt platziert sind.');
            }
        }, 2000);
    </script>
</body>
</html>
